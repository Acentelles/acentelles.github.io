<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HyperNova by Hand | Alberto Centelles</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="HyperNova by Hand" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Building on top of the techniques explored with SuperSpartan in part 1, the aim of this article is to unbundle the folding mechanism of the HyperNova protocol by writing it by hand. There is much wisdom hidden in the details." />
<meta property="og:description" content="Building on top of the techniques explored with SuperSpartan in part 1, the aim of this article is to unbundle the folding mechanism of the HyperNova protocol by writing it by hand. There is much wisdom hidden in the details." />
<link rel="canonical" href="http://localhost:4000/cryptography/2024/08/05/hypernova-by-hand.html" />
<meta property="og:url" content="http://localhost:4000/cryptography/2024/08/05/hypernova-by-hand.html" />
<meta property="og:site_name" content="Alberto Centelles" />
<meta property="og:image" content="http://localhost:4000/media/hypernova.jpeg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-08-05T00:00:00+01:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/media/hypernova.jpeg" />
<meta property="twitter:title" content="HyperNova by Hand" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-08-05T00:00:00+01:00","datePublished":"2024-08-05T00:00:00+01:00","description":"Building on top of the techniques explored with SuperSpartan in part 1, the aim of this article is to unbundle the folding mechanism of the HyperNova protocol by writing it by hand. There is much wisdom hidden in the details.","headline":"HyperNova by Hand","image":"http://localhost:4000/media/hypernova.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/cryptography/2024/08/05/hypernova-by-hand.html"},"url":"http://localhost:4000/cryptography/2024/08/05/hypernova-by-hand.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Alberto Centelles" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Alberto Centelles</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">HyperNova by Hand</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-08-05T00:00:00+01:00" itemprop="datePublished">Aug 5, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <blockquote>
  <p><em>I’d like to thank Nicolas Mohnblatt for brainstorming, discussing and reviewing this article, and for his many shared insights, and to Srinath Setty for providing the inspiration for this work and feedback.</em>
<em>This article wouldn’t have been possible without them. All mistakes are my own.</em></p>
</blockquote>

<p>This article was originally written on a SageMath Jupyter notebook, which can be found <a href="https://github.com/Acentelles/blogposts/tree/main/hypernova">here</a>.</p>

<h2 id="folding-ccs-relations-in-hypernova">Folding CCS relations in HyperNova</h2>

<p>In <a href="./superspartan-by-hand.md">part 1</a>, we managed to verify the validity of a CCS relation using the sum-check. The goal was to get ourselves familiar with the mechanics of the protocol. In particular, we saw that two sum-checks are run for such a CCS relation, and how the two sum-checks relate.</p>

<ul>
  <li><strong>Outer sum-check</strong>: $0 = G(x)$ for all $x \in {0,1}^2$.</li>
  <li><strong>(Batched) inner sum-checks</strong>: $v_j = \sum_{y\in {0,1}^{3}} \widetilde{M}_j(r,y) \cdot \widetilde{z}(y)$</li>
</ul>

<p>The goal of this post is to go beyond a single CCS instance to a folding of many as is done in the HyperNova paper. One of the main insights of folding in HyperNova is that we can accumulate or delay the computation of the inner sum-checks.</p>

<h2 id="linearised-committed-ccs-lcccs">Linearised Committed CCS (LCCCS)</h2>

<p>Recall that a <em>relation</em> $\mathcal{R}$ in CCS is composed by:</p>
<ul>
  <li>a <em>structure</em> $s := ([M_1, …, M_t], [S_1,…,S_q], [c_1, …, c_q])$, plus some other bound parameters such as the number of rows $m$ and columns $n$ of the matrices $M_i$.</li>
  <li>an <em>instance</em>, which consists of public inputs $\times \in \mathbb{F}^l$ and private inputs $\omega \in \mathbb{F}^m$.</li>
</ul>

<p>that satisfies that $(s, \times, \omega) \in \mathcal{R}_{CCS}$ if and only if for all $x \in {0,1}^{\log m}$</p>

<p>$\begin{aligned}
&amp; \sum_{i=1}^q c_i \cdot (\prod_{j\in S_i} (\sum_{y\in {0,1}^{\log m}} \widetilde{M}_j(x,y) \cdot \widetilde{z}(y))) = 0
\end{aligned}$</p>

<p>where $\widetilde{z}(y)=\widetilde{(\omega, \times, 1)}(y)$</p>

<p>In HyperNova, CCS relations are modified for folding:</p>

<ul>
  <li>A <em>Linearised CCS</em> relation $\mathcal{R}_{LCCS}$ contains only inner linear sum-checks. Concretely,</li>
</ul>

<p>$\begin{aligned}
(s, (u, x, r, {v_1,…,v_t}), \widetilde{w}) \in \mathcal{R}<em>{LCCS} 
\iff v_i = \sum</em>{y \in { 0,1}} \widetilde{M_i}(r, y) \cdot \widetilde{z}(y)
\end{aligned}$.</p>

<blockquote>
  <p>One can think of an LCCS instance as an object that encapsulates the inner sum-checks that are left after computing the outer sum-check of a CCS instance.</p>
</blockquote>

<ul>
  <li>A <em>Committed CCS</em> relation $(C, s, \times, \omega) \in \mathcal{R}_{CCCS}$ is a CCS instance where a commitment to the witness $\omega$ is also presented in the instance.</li>
  <li>A <em>Linearised Committed CCS</em> instance $(C, s, (u, x, r, {v_1,…,v_t}), \widetilde{w}) \in \mathcal{R}_{LCCCS}$ is a linearised instance with a commitment to the witness $\omega$ of the instance.</li>
</ul>

<h2 id="multi-folding-for-ccs-construction">Multi-folding for CCS construction</h2>

<p>Folding in HyperNova takes an <em>accumulated</em> relation $R_1 \in \mathcal{R}<em>{LCCCS}$ and a new, incoming relation $R_2 \in \mathcal{R}</em>{CCCS}$, and returns a new accumulated relation $R_3 \in \mathcal{R}_{LCCCS}$.</p>

<p>$\begin{aligned}
f : \mathcal{R}<em>{LCCCS} \times \mathcal{R}</em>{CCCS} &amp;\to \mathcal{R}_{LCCCS} <br />
(R_1, R_2) &amp;\mapsto R_3 
\end{aligned}$</p>

<p>More precisely, a folding step will require us to prove the sums in:</p>
<ul>
  <li>$R_1 \in \mathcal{R}<em>{LCCCS}$: $v_i = \sum</em>{y \in { 0,1}} \widetilde{M_i}(r, y) \cdot \widetilde{z}(y)$</li>
  <li>$R_2 \in \mathcal{R}<em>{CCCS}$: $\sum</em>{i=1}^q c_i \cdot (\prod_{j\in S_i} (\sum_{y\in {0,1}^{\log m}} \widetilde{M}_j(x,y) \cdot \widetilde{z}(y))) = 0$</li>
</ul>

<p>while delaying some of the sum-checks for later steps, which are encoded in $R_3 \in \mathcal{R}_{LCCCS}$.</p>

<h2 id="folding-fibonacci">Folding Fibonacci</h2>

<p>To illustrate the workings of folding in HyperNova, we’ll perform two iterations of our Fibonacci example:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// i-th iteration</span>
<span class="nf">fibonacci</span><span class="p">(</span><span class="n">x_2</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">y_2</span><span class="p">,</span> <span class="n">y_1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_1</span> <span class="o">+</span> <span class="n">x_2</span> <span class="c1">// Fibonacci</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_1</span> <span class="o">*</span> <span class="n">y_2</span> <span class="c1">// Multiplicative Fibonacci</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>     <span class="c1">// Fibonacci x (Multiplicative Fibonacci)</span>
    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Recall that a Fibonacci iteration arithmetises in CCS as follows:</p>

<p>$\begin{aligned}<br />
&amp; \overbrace{1}^{c_1} \cdot \overbrace{\begin{bmatrix} <br />
1 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \   0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 \ 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \  \end{bmatrix}  }^{M_1} 
\overbrace{\begin{bmatrix} x_2 \ x_1 \ x \ y_2 \ y_1 \ y \ t \ 1 \end{bmatrix}}^z \circ
\overbrace{\begin{bmatrix}   0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 \   0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 \ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \  \end{bmatrix}}^{M_2}<br />
\overbrace{\begin{bmatrix} x_2 \ x_1 \ x \ y_2 \ y_1 \ y \ t \ 1 \end{bmatrix}}^z <br />
+&amp; \overbrace{(-1)}^{c_1} \cdot \overbrace{\begin{bmatrix}   0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \   0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 \ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 \ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \  \end{bmatrix}}^{M_3} 
\overbrace{\begin{bmatrix} x_2 \ x_1 \ x \ y_2 \ y_1 \ y \ t \ 1 \end{bmatrix}}^z
= \overbrace{\begin{bmatrix} 0 \ 0 \ 0 \ 0 \ 0 \ 0 \ 0 \ 0 \end{bmatrix}}^{\vec{0}}
\end{aligned}$</p>

<blockquote>
  <p>Multi-folding refers to the property that instances of different structures can be folded together. However, the structure $s_i$ for each instance in our fibonacci example will be the same. That is, $s = s_1 = s_2 = ([\widetilde{M}_1, \widetilde{M}_2, \widetilde{M}_3], [S_1, S_2], [c_1, c_2])$, where $S_1 = {1, 2}$, $S_2 = { 3 }$, $c_1 = 1$, $c_2 = -1$.</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Necessary boilerplate from our last post
</span><span class="n">k</span> <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">"x1, x2, y1, y2, y3, x11, x22, y11, y22, y33"</span><span class="p">)</span>
<span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">x11</span><span class="p">,</span> <span class="n">x22</span><span class="p">,</span> <span class="n">y11</span><span class="p">,</span> <span class="n">y22</span><span class="p">,</span> <span class="n">y33</span> <span class="o">=</span> <span class="n">R</span><span class="p">.</span><span class="n">gens</span><span class="p">()</span>

<span class="n">eqx</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x11</span><span class="p">)</span> <span class="o">+</span> <span class="n">x1</span><span class="o">*</span><span class="n">x11</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x22</span><span class="p">)</span> <span class="o">+</span> <span class="n">x2</span><span class="o">*</span><span class="n">x22</span><span class="p">)</span>
<span class="n">eqy</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y11</span><span class="p">)</span> <span class="o">+</span> <span class="n">y1</span><span class="o">*</span><span class="n">y11</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y22</span><span class="p">)</span> <span class="o">+</span> <span class="n">y2</span><span class="o">*</span><span class="n">y22</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y33</span><span class="p">)</span> <span class="o">+</span> <span class="n">y3</span><span class="o">*</span><span class="n">y33</span><span class="p">)</span>

<span class="n">M1</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="p">])</span>

<span class="n">M2</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="p">])</span>

<span class="n">M3</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="p">])</span>
</code></pre></div></div>

<p>Recall also that the multilinear extensions $\widetilde{M_i}$ of $M_i$ and $\widetilde{z}$ of $z$ are defined as</p>

<p>$\begin{aligned}
\widetilde{M_i}(X, Y) &amp;:= \sum_{x \in {0, 1 }^{s}} \sum_{y \in {0, 1 }^{s’}} M_i(x, y) \cdot \widetilde{eq}(x, X) \cdot \widetilde{eq}(y, Y)
\end{aligned}$</p>

<p>$\widetilde{z}(Y) := \sum_{y \in {0, 1 }^{s’}} z(y) \cdot \widetilde{eq}(y, Y)$.</p>

<p>And that to apply the sum-check, the CCS relation</p>

<p>$1 \cdot (M_1 \cdot z \circ M_2 \cdot z) + (-1) \cdot (M_3 \cdot z) = \vec{0}$</p>

<p>is thus turned into a polynomial equation</p>

<p>$\begin{aligned}
G((X_1, X_2)) := &amp; 1 \cdot (\sum_{y \in {0, 1 }^3} \widetilde{M_1}((X_1, X_2), y) \cdot \widetilde{z}(y) \cdot \sum_{y \in {0, 1 }^{3}} \widetilde{M_1}((X_1, X_2), y) \cdot \widetilde{z}(y)) \  + &amp; (-1) \cdot (\sum_{y \in {0, 1 }^{3}} \widetilde{M_3}((X_1, X_2), y) \cdot \widetilde{z}(y)) = \vec{0}
\end{aligned}$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># From-binary-to-decimal polynomials
</span><span class="n">row</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">x2</span>
<span class="n">col</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">y2</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">y3</span>

<span class="k">def</span> <span class="nf">Mi_linear</span><span class="p">(</span><span class="n">Mi</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span>
            <span class="nb">sum</span><span class="p">([</span>
                <span class="nb">sum</span><span class="p">([</span>
                    <span class="nb">sum</span><span class="p">([</span>
                        <span class="nb">sum</span><span class="p">([</span>
                            <span class="n">Mi</span><span class="p">[</span><span class="n">Integer</span><span class="p">(</span><span class="n">row</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">x2</span><span class="p">))][</span><span class="n">Integer</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y3</span><span class="o">=</span><span class="n">y3</span><span class="p">))]</span> <span class="o">*</span> <span class="n">eqx</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="o">=</span><span class="n">x2</span><span class="p">,</span><span class="n">x11</span><span class="o">=</span><span class="n">x11</span><span class="p">,</span><span class="n">x22</span><span class="o">=</span><span class="n">x22</span><span class="p">)</span> <span class="o">*</span> <span class="n">eqy</span><span class="p">(</span><span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">y11</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span> <span class="n">y22</span><span class="o">=</span><span class="n">y22</span><span class="p">,</span> <span class="n">y3</span><span class="o">=</span><span class="n">y3</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">y33</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">y3</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">for</span> <span class="n">y2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">y1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
         <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

<span class="k">def</span> <span class="nf">z_linear</span><span class="p">(</span><span class="n">zi</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span>
                <span class="nb">sum</span><span class="p">([</span>
                    <span class="nb">sum</span><span class="p">([</span>
                        <span class="n">zi</span><span class="p">[</span><span class="n">Integer</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y3</span><span class="o">=</span><span class="n">y3</span><span class="p">))]</span><span class="o">*</span> <span class="n">eqy</span><span class="p">(</span><span class="n">y1</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">y11</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span> <span class="n">y22</span><span class="o">=</span><span class="n">y22</span><span class="p">,</span> <span class="n">y3</span><span class="o">=</span><span class="n">y3</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">y33</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">y3</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">y2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">y1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

<span class="k">def</span> <span class="nf">Mi_z_prod</span><span class="p">(</span><span class="n">Mi</span><span class="p">,</span> <span class="n">zi</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span>
                <span class="nb">sum</span><span class="p">([</span>
                    <span class="nb">sum</span><span class="p">([</span>
                        <span class="n">Mi_linear</span><span class="p">(</span><span class="n">Mi</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zi</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">y3</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">y2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">y1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
</code></pre></div></div>

<h2 id="iteration-1-base-case">Iteration 1 (base case)</h2>

<p>As we did in our previous post, we provide the initial values $x_2 = 0, x_1 = 1, y_2=2, y_1=3$ to the Fibonacci step function, which outputs $x = 1, y=6, t=6$.</p>

<p>The ingredients for our first iterations are:</p>

<ul>
  <li><strong>Accumulated relation</strong> $R_1 = \bot \in \mathcal{R}_{LCCCS}$</li>
  <li><strong>Incoming relation</strong> $R_2 = (s, C_2, \times_2) \in \mathcal{R}_{CCCS}$</li>
  <li><strong>Accumulated instance</strong> $\widetilde{z}_1 = \bot$</li>
  <li><strong>Incoming instance</strong> $\widetilde{z}_2 = \widetilde{(\omega_2, \times_2, 1)}$, where $\omega_2 = ()$ and $\times_2 = (0,1,1,2,3,6,6)$.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">public_x2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="n">private_w2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">z2</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">private_w2</span> <span class="o">+</span> <span class="n">public_x2</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">z2</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(0, 1, 1, 2, 3, 6, 6, 1)
</code></pre></div></div>

<h3 id="checking-r_1-in-mathcalr_lcccs">Checking $R_1 \in \mathcal{R}_{LCCCS}$</h3>

<p>In this first iteration or base case, our accumulated instance $R_1$ is empty, so there is no sum-check to run.</p>

<h3 id="checking-for-r_2-in-mathcalr_cccs">Checking for $R_2 \in \mathcal{R}_{CCCS}$</h3>

<p>The prover wants to prove that $G((x_1, x_2)) = 0$ for all $x_1, x_2 \in {0,1}$ using the sum-check.</p>

<p>That is $G((0,0))= G((0,1))= G((1,0))= G((1,1))=0$, where</p>

<p>$\begin{aligned}
G((X_1, X_2)) := &amp; \sum_{y \in {0, 1 }^3} \widetilde{M_1}((X_1, X_2), y) \cdot \widetilde{z}<em>2(y) \cdot \sum</em>{y \in {0, 1 }^{3}} \widetilde{M_2}((X_1, X_2), y) \cdot \widetilde{z}<em>2(y) \<br />
-&amp; (\sum</em>{y \in {0, 1 }^{3}} \widetilde{M_3}((X_1, X_2), y) \cdot \widetilde{z}_2(y)) = 0
\end{aligned}$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">G</span> <span class="o">=</span> <span class="n">Mi_z_prod</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Mi_z_prod</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Mi_z_prod</span><span class="p">(</span><span class="n">M3</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>
<span class="n">G</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>21*x11^2*x22^2 - 17*x11^2*x22 - 15*x11*x22^2 + 2*x11^2 + 11*x11*x22 - 2*x11
</code></pre></div></div>

<p>As we did in the previous post, we compute the multilinear extension of $G((X_1,X_2))$, $h((X_1,X_2)) = \sum_{x_1,x_2 \in {0,1}} \widetilde{eq}((X_1,X_2),(x_1,x_2)) \cdot G((x_1, x_2))$.</p>

<p>Checking that $h$ is the zero polynomial implies with high probability that for all $x \in { 0,1}^2$, $G(x) = 0$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">h</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
        <span class="nb">sum</span><span class="p">([</span>
            <span class="n">G</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">x11</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span><span class="n">x22</span><span class="p">)</span> <span class="o">*</span> <span class="n">eqx</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">x11</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span><span class="n">x22</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x22</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
     <span class="k">for</span> <span class="n">x11</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

<span class="n">h</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
</code></pre></div></div>

<p>To check that $h = 0$, we can apply the Swartz-Zippel lemma and evaluate $h$ at a random point $\beta := (\beta_1, \beta_2)$.</p>

<p>Thus, the verifier samples a random challenge $\beta := (\beta_1, \beta_2)$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">beta1</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">beta2</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>

<span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(91, 30)
</code></pre></div></div>

<p>The prover computes $h((\beta_1,\beta_2))$ and sends it to the verifier. The goal of the verifier is to check that $h((\beta_1,\beta_2))$ is indeed this sum:</p>

<p>$h((\beta_1,\beta_2)) = \sum_{x_1,x_2 \in {0,1}} \widetilde{eq}((\beta_1,\beta_2),(x_1,x_2)) \cdot G((x_1, x_2))$</p>

<p>Equivalently, it is checking that $\sum_{x_1 \in {0,1}}\sum_{x_2 \in {0,1}} Q(x_1, x_2) = 0$ where</p>

<p>$Q(X_1, X_2) := G((X_1, X_2)) \cdot \widetilde{eq}((\beta_1, \beta_2), (X_1, X_2))$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Q</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="n">eqx</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="n">beta1</span><span class="p">,</span><span class="n">x2</span><span class="o">=</span><span class="n">beta2</span><span class="p">)</span>
<span class="n">Q</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>39*x11^3*x22^3 + 17*x11^3*x22^2 - 5*x11^2*x22^3 - 4*x11^3*x22 + 5*x11^2*x22^2 - 39*x11*x22^3 + 6*x11^3 + 41*x11^2*x22 + 6*x11*x22^2 - 38*x11^2 + 41*x11*x22 + 32*x11
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sum</span><span class="p">([</span> 
    <span class="nb">sum</span><span class="p">([</span> <span class="n">Q</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span><span class="n">x2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
<span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<h4 id="round-1">Round 1</h4>

<p>The prover $P$ sends the verifier $V$ a univariate polynomial $s_1(X_1)$ claiming to be equal to $Q_1(X_1) := \sum_{x_2 \in {0,1}} Q(X_1, x_2)$. That is, we keep the first variable unbound while summing up the values over the boolean hypercube.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Q1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="n">Q</span><span class="p">(</span><span class="n">x22</span><span class="o">=</span><span class="n">x2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">s1</span> <span class="o">=</span> <span class="n">Q1</span>

<span class="n">s1</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-37*x11^3 - 35*x11^2 - 29*x11
</code></pre></div></div>

<p>The verifier first checks that $s_1(0) + s_1(1)$ matches the expected result, i.e. $s_1(0) + s_1(1) = 0$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s1</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">s1</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>The verifier checks $s_1 = Q_1$ by checking that $Q_1$ and $s_1$ agree at a random point $r_1$ (Schwartz-Zippel lemma)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">r1</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">r1</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>95
</code></pre></div></div>

<p>The verifier can compute directly $s_1(r_1)$ but doesn’t know what $Q_1$ is, so the check $s_1 = Q_1$ must be done recursively.</p>

<h4 id="round-2-final">Round 2 (final)</h4>

<p>The new claim is that $s_1(r_1) := \sum_{x_2 \in {0,1}} Q(r_1, x_2)$</p>

<p>The prover sends the verifier a univariate $s_2(X_2)$ which he claims to be equal to  $Q_2(X_2) := Q(r_1, X_2)$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Q2</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">r1</span><span class="p">)</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">Q2</span>

<span class="n">s2</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>13*x22^3 + 7*x22^2 - 27*x22 - 28
</code></pre></div></div>

<p>The verifier first checks that $s_1(r_1)$ is indeed $s_2(0) + s_2(1)$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s2</span><span class="p">(</span><span class="n">x22</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">s2</span><span class="p">(</span><span class="n">x22</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">s1</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">r1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>The verifier sends a random challenge $r_2$ to check that $s_2(r_2) = Q_2(r_2)$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">r2</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">r2</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>70
</code></pre></div></div>

<p>There is no more need for recursion, since the verifier may now evaluate $Q(r_1, r_2) = Q_2(r_2)$.</p>

<p>However, to compute $Q_2(r_2)$ the verifier must know the value of the sums</p>

<p>$\begin{aligned}
v_i &amp;= \sum_{y_1 \in {0, 1 }} \sum_{y_2 \in {0, 1 }} \sum_{y_3 \in {0, 1 }} \widetilde{M_i}((r_1, r_2), (y_1, y_2, y_3)) \cdot \widetilde{z}_2((y_1, y_2, y_3)) <br />
\end{aligned}$</p>

<p>To assist the verifier in this computation, the prover computes 
$v_i = \sum_{y \in {0, 1 }^3} \widetilde{M_i}((r_1, r_2), y) \cdot \widetilde{z}_2(y)$ and sends them to the verifier.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">v_generator</span><span class="p">(</span><span class="n">Mi</span><span class="p">,</span> <span class="n">zi</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span>
        <span class="nb">sum</span><span class="p">([</span>
            <span class="nb">sum</span><span class="p">([</span>
                <span class="n">Mi_linear</span><span class="p">(</span><span class="n">Mi</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">r1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">r2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zi</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y3</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">y2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">y1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

<span class="n">v1</span> <span class="o">=</span> <span class="n">v_generator</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>
<span class="n">v2</span> <span class="o">=</span> <span class="n">v_generator</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>
<span class="n">v3</span> <span class="o">=</span> <span class="n">v_generator</span><span class="p">(</span><span class="n">M3</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>

<span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">,</span><span class="n">v3</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(37, -48, -8)
</code></pre></div></div>

<h3 id="accumulating-sum-checks-into-r_3-in-mathcalr_lcccs">Accumulating sum-checks into $R_3 \in \mathcal{R}_{LCCCS}$</h3>

<p>Instead of engaging in a sum-check now, they construct $R_3 \in \mathcal{R}_{LCCCS}$, which serves as an accumulation of these inner sum-checks:</p>

<p>$R_3 = (s, C_3, (u_3, \times_3, (r_1, r_2), {v_1,v_2,v_3}))$</p>

<p>where $C_3 = C_2$, $u_3 = 1$, $\times_3 = \times_2$.</p>

<p>So, by checking $R_3$ in a future step, the verifier will verify that $v_1, v_2, v_3$ were computed correctly, thus avoiding running any inner sum-check at this step. <strong>Folding for the win!</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">u3</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">public_x3</span> <span class="o">=</span> <span class="n">public_x2</span>
</code></pre></div></div>

<h2 id="iteration-2-iterative-case">Iteration 2 (iterative case)</h2>

<ul>
  <li><strong>Accumulated relation</strong> $R’<em>1 = R_3 = (s, C_3, (u_3, \times_3, (r_1, r_2), {v_1,v_2,v_3})) \in \mathcal{R}</em>{LCCCS}$</li>
  <li><strong>Incoming relation</strong> $R’<em>2 = (s, C’_2, \times’_2) \in \mathcal{R}</em>{CCCS}$</li>
  <li><strong>Accumulated instance</strong> $\widetilde{z}’_1 = \widetilde{(\omega_3, \times_3, u_3)}$</li>
  <li><strong>Incoming instance</strong> $\widetilde{z}’_2 = \widetilde{(\omega’_2, \times’_2, 1)}$ where $\omega’_2 = ()$ and $\times’_2 = (1,1,2,3,6,18,36)$.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">public_xx1</span> <span class="o">=</span> <span class="n">public_x3</span>
<span class="n">zz1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">public_xx1</span> <span class="o">+</span> <span class="p">[]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">zz1</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(0, 1, 1, 2, 3, 6, 6, 1)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">public_xx2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">36</span><span class="p">]</span>
<span class="n">zz2</span> <span class="o">=</span> <span class="n">vector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">public_xx2</span> <span class="o">+</span> <span class="p">[]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">zz2</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(1, 1, 2, 3, 6, 18, 36, 1)
</code></pre></div></div>

<h3 id="checking-r1-in-mathcalrlcccs">Checking $R’<em>1 \in \mathcal{R}</em>{LCCCS}$</h3>

<p>The verifier wants to check that $v_i = H’<em>i((r_1, r_2))$, where $H’_i(x) = \sum</em>{y \in {0, 1 }^3} \widetilde{M_i}(x, y) \cdot \widetilde{z}’_1(y)$, as the prover claims.</p>

<p>By <em>lemma 6</em> of the HyperNova paper, since $H_i$ is a multilinear polynomial in two variables,</p>

<p>$H_i((X_1, X_2)) = \sum_{x_1 \in {0, 1 }} \sum_{x_2 \in {0, 1 }} \widetilde{eq}((X_1, X_2), (x_1, x_2)) \cdot H_i((x_1, x_2))$</p>

<p>So the prover is tasked to convince the verifier that</p>

<p>$v_i = H_i((r_1, r_2)) = \sum_{x_1 \in {0, 1 }} \sum_{x_2 \in {0, 1 }}  L_i((x_1, x_2))$</p>

<p>where
$L_i((X_1, X_2)) = \widetilde{eq}((r_1, r_2), (X_1, X_2)) \cdot H_i((X_1, X_2))$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">H_generator</span><span class="p">(</span><span class="n">Mi</span><span class="p">,</span> <span class="n">zi</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span>
        <span class="nb">sum</span><span class="p">([</span>
            <span class="nb">sum</span><span class="p">([</span>
                <span class="n">Mi_linear</span><span class="p">(</span><span class="n">Mi</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zi</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y3</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">y2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">y1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

<span class="n">H1</span> <span class="o">=</span> <span class="n">H_generator</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">zz1</span><span class="p">)</span>
<span class="n">H2</span> <span class="o">=</span> <span class="n">H_generator</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="n">zz1</span><span class="p">)</span>
<span class="n">H3</span> <span class="o">=</span> <span class="n">H_generator</span><span class="p">(</span><span class="n">M3</span><span class="p">,</span> <span class="n">zz1</span><span class="p">)</span>

<span class="p">(</span><span class="n">H1</span><span class="p">,</span> <span class="n">H2</span><span class="p">,</span> <span class="n">H3</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(-3*x11*x22 + 2*x11 + 1,
 -7*x11*x22 + x11 + 5*x22 + 1,
 -11*x11*x22 + 5*x11 + 5*x22 + 1)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">L1</span> <span class="o">=</span> <span class="n">eqx</span><span class="p">(</span><span class="n">x1</span> <span class="o">=</span> <span class="n">r1</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span> <span class="n">r2</span><span class="p">)</span> <span class="o">*</span> <span class="n">H1</span>
<span class="n">L2</span> <span class="o">=</span> <span class="n">eqx</span><span class="p">(</span><span class="n">x1</span> <span class="o">=</span> <span class="n">r1</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span> <span class="n">r2</span><span class="p">)</span> <span class="o">*</span> <span class="n">H2</span>
<span class="n">L3</span> <span class="o">=</span> <span class="n">eqx</span><span class="p">(</span><span class="n">x1</span> <span class="o">=</span> <span class="n">r1</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span> <span class="n">r2</span><span class="p">)</span> <span class="o">*</span> <span class="n">H3</span>

<span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L3</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(-33*x11^2*x22^2 - 43*x11^2*x22 + 10*x11*x22^2 - 24*x11^2 - 28*x11*x22 + 32*x11 - 37*x22 + 22,
 24*x11^2*x22^2 - 6*x11^2*x22 + 11*x11*x22^2 - 12*x11^2 - 38*x11*x22 + 17*x22^2 + 10*x11 - 28*x22 + 22,
 -20*x11^2*x22^2 - 15*x11^2*x22 - 43*x11*x22^2 + 41*x11^2 + 29*x11*x22 + 17*x22^2 - 3*x11 - 28*x22 + 22)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Sanity check
</span><span class="n">H1</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span> <span class="n">r1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span><span class="n">r2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">([</span> <span class="nb">sum</span><span class="p">([</span> <span class="n">L1</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span><span class="n">x2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span><span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<h3 id="batching-sum-checks-in-r1-in-mathcalrlcccs">Batching sum-checks in $R’<em>1 \in \mathcal{R}</em>{LCCCS}$</h3>

<p>Instead of engaging in three separate sum-checks, the verifier samples a random element $\gamma \in \mathbb{F}$, and the three sums $\sum_{x_1 \in {0, 1 }} \sum_{x_2 \in {0, 1 }}  L_i((x_1, x_2))$ for $i \in {1,2,3}$ are simultaneously checked together by using a random linear combination of $L_i$, $g_1(x) = \sum_{j \in {1,2,3}} \gamma^j \cdot L_j(x)$</p>

<p>Checking that</p>

<p>$\sum_{j \in {1,2,3}} \gamma^j \cdot v_j = \sum_{x_1 \in {0, 1 }} \sum_{x_2 \in {0, 1 }}  g_1((x_1, x_2))$</p>

<p>implies with high probability that</p>

<p>$v_i = \sum_{x_1 \in {0, 1 }} \sum_{x_2 \in {0, 1 }}  L_i((x_1, x_2))$</p>

<p>for each $i \in {1,2,3}$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gamma</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">gamma</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>23
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">g1</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">L1</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="n">L2</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="n">L3</span>
<span class="n">g1</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-12*x11^2*x22^2 - 20*x11^2*x22 - 12*x11*x22^2 - 24*x11^2 + 9*x11*x22 - 5*x22^2 + 27*x11 - 11*x22 + 48
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sum</span><span class="p">([</span> 
    <span class="nb">sum</span><span class="p">([</span> <span class="n">g1</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span><span class="n">x2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
<span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span> <span class="o">==</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v3</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>The prover thus sends the sum $\sum_{j \in {1,2,3}} \gamma^j \cdot v_j$ to the verifier.</p>

<p>Note that the verifier is delaying these checks for now. They will later be further batched with other sum-checks from $R’_2$.</p>

<h3 id="checking-r2-in-mathcalrcccs">Checking $R’<em>2 \in \mathcal{R}</em>{CCCS}$</h3>

<p>As we did for $R_2$, the verifier aims to check that $0 = G’(X), X \in { 0,1}^2$, where</p>

<p>$\begin{aligned}
G’((X_1, X_2)) := &amp; \sum_{y \in {0, 1 }^3} \widetilde{M_1}((X_1, X_2), y) \cdot \widetilde{z}’<em>2(y) \cdot \sum</em>{y \in {0, 1 }^{3}} \widetilde{M_2}((X_1, X_2), y) \cdot \widetilde{z}’<em>2(y) \  - &amp; (\sum</em>{y \in {0, 1 }^{3}} \widetilde{M_3}((X_1, X_2), y) \cdot \widetilde{z}’_2(y)) = 0
\end{aligned}$</p>

<p>$\widetilde{z}’_2 = \widetilde{(\omega’_2, \times’_2, 1)}$ where $\omega’_2 = ()$ and $\times’_2 = (1,1,2,3,6,18,36)$</p>

<p>This is equivalent to checking that $\sum_{x_1 \in {0,1}}\sum_{x_2 \in {0,1}} Q’(x_1, x_2) = 0$ where</p>

<p>$Q’(X_1, X_2) := G’((X_1, X_2)) \cdot \widetilde{eq}((\beta’_1, \beta’_2), (X_1, X_2))$, since</p>

<p>$\sum_{x_1 \in {0,1}}\sum_{x_2 \in {0,1}} G’((x_1, x_2)) \cdot \widetilde{eq}((X_1, X_2), (x_1, x_2))$ is a multilinear polynomial, thus uniquely determined, so it is equal to zero. Thus we apply the Schwartz-Zippel lemma by randomly evaluate it to $(\beta’_1, \beta’_2)$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">GG</span> <span class="o">=</span> <span class="n">Mi_z_prod</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">zz2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Mi_z_prod</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="n">zz2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Mi_z_prod</span><span class="p">(</span><span class="n">M3</span><span class="p">,</span> <span class="n">zz2</span><span class="p">)</span>
<span class="n">GG</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>19*x11^2*x22^2 + 9*x11^2*x22 - x11*x22^2 + 8*x11^2 - 27*x11*x22 - 8*x11
</code></pre></div></div>

<p>The verifier samples a random challenge $\beta’ := (\beta’_1, \beta’_2)$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">beta11</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">beta22</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>

<span class="p">(</span><span class="n">beta11</span><span class="p">,</span> <span class="n">beta22</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(26, 39)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QQ</span> <span class="o">=</span> <span class="n">GG</span> <span class="o">*</span> <span class="n">eqx</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="n">beta11</span><span class="p">,</span><span class="n">x2</span><span class="o">=</span><span class="n">beta22</span><span class="p">)</span>
<span class="n">QQ</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-26*x11^3*x22^3 + 36*x11^3*x22^2 - x11^2*x22^3 + 36*x11^3*x22 - 43*x11^2*x22^2 + 6*x11*x22^3 + 50*x11^3 + 21*x11^2*x22 + 20*x11*x22^2 - 25*x11^2 - 49*x11*x22 - 25*x11
</code></pre></div></div>

<h3 id="batching-sum-checks-in-r1-in-mathcalrlcccs-and--r2-in-mathcalrcccs">Batching sum-checks in $R’<em>1 \in \mathcal{R}</em>{LCCCS}$ and  $R’<em>2 \in \mathcal{R}</em>{CCCS}$</h3>

<p>We now batch:</p>
<ul>
  <li>The <em>remaining batched check</em> on $R’<em>1$, $g_1(x) = \sum</em>{j \in {1,2,3}} \gamma^j \cdot L_j(x)$</li>
  <li>The <em>new check</em> $G’(x) = 0$</li>
</ul>

<p>Using a random linear combination $g(x) = g_1(x) + \gamma^4 Q’(x)$.</p>

<p>As expected, proving the new sum:</p>

<p>$\sum_{j \in {1,2,3}} \gamma^j \cdot v_j + \gamma^4 \cdot 0 = \sum_{x_1 \in {0, 1 }} \sum_{x_2 \in {0, 1 }}  g((x_1, x_2))$</p>

<p>will in turn prove with high probability the batched checks.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">g</span> <span class="o">=</span> <span class="n">g1</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">4</span> <span class="o">*</span> <span class="n">QQ</span>
<span class="n">g</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-28*x11^3*x22^3 + 31*x11^3*x22^2 + 30*x11^2*x22^3 + 31*x11^3*x22 - 35*x11^2*x22^2 + 22*x11*x22^3 + 15*x11^3 - 44*x11^2*x22 - 6*x11*x22^2 + 19*x11^2 - 36*x11*x22 - 5*x22^2 - 31*x11 - 11*x22 + 48
</code></pre></div></div>

<p>$v = \sum_{j \in {1,2,3}} \gamma^j \cdot v_j + \gamma^4 \cdot 0$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">gamma</span><span class="o">^</span><span class="mi">1</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">0</span>
<span class="n">v</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>30
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sum</span><span class="p">([</span> 
    <span class="nb">sum</span><span class="p">([</span> <span class="n">g</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span><span class="n">x2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
<span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span> <span class="o">==</span> <span class="n">v</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<h4 id="round-1-1">Round 1</h4>
<p>Prover sends $s’_1$ claiming to be $g’_1$</p>

<p>$g’<em>1(X_1) := \sum</em>{x_2 \in {0,1}} g(X_1, x_2)$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gg1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span> <span class="n">g</span><span class="p">(</span><span class="n">x22</span><span class="o">=</span><span class="n">x2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">ss1</span> <span class="o">=</span> <span class="n">gg1</span>

<span class="n">ss1</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-37*x11^3 - 11*x11^2 + 19*x11 - 21
</code></pre></div></div>

<p>The verifier first checks that $s’_1(0) + s’_1(1)$ matches the expected result, i.e. $s’_1(0) + s’_1(1) = v$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ss1</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ss1</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">v</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>The verifier checks $s’_1 = g’_1$ by checking that $g’_1$ and $s’_1$ agree at a random point $r’_1$ (Schwartz-Zippel lemma)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rr1</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">rr1</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>64
</code></pre></div></div>

<p>The verifier can compute directly $s’_1(r’_1)$ but doesn’t know what $g’_1$ is, so the check $s’_1 = g’_1$ must be done recursively.</p>

<h4 id="round-2-final-1">Round 2 (final)</h4>

<p>The new claim is that $s’<em>1(r’_1) := \sum</em>{x_2 \in {0,1}} g(r’_1, x_2)$</p>

<p>The prover sends the verifier a univariate $s’_2(X_2)$ which he claims to be equal to  $g’_2(X_2) := g(r’_1, X_2)$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gg2</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">)</span>
<span class="n">ss2</span> <span class="o">=</span> <span class="n">gg2</span>

<span class="n">ss2</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-x22^3 - 22*x22^2 - 28*x22 - 36
</code></pre></div></div>

<p>The verifier first checks that $s’_1(r_1)$ is indeed $s’_2(0) + s’_2(1)$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ss2</span><span class="p">(</span><span class="n">x22</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ss2</span><span class="p">(</span><span class="n">x22</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">ss1</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>The verifier sends a random challenge $r’_2$ to check that $s’_2(r’_2) = g’_2(r’_2)$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rr2</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">rr2</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>67
</code></pre></div></div>

<p>There is no more need for recursion, since the verifier may now evaluate $g(r’_1, r’_2) = g’_2(r’_2)$.</p>

<p>However, to compute $g’_2(r’_2)$ the verifier must know the value of the sums</p>

<p>$\sigma_i = \sum_{y \in {0, 1 }^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot \widetilde{z}’_1(y)$</p>

<p>$\theta_i = \sum_{y \in {0, 1 }^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot \widetilde{z}’_2(y)$</p>

<p>for $i \in {1,2,3}$, since</p>

<p>$
\begin{aligned}
s’<em>2(r’_2) &amp;= g’_2(r’_2) \ 
&amp;= g((r’_1, r’_2)) <br />
&amp;= g_1((r’_1, r’_2)) + \gamma^4 Q’((r’_1, r’_2)) <br />
&amp;= \sum</em>{j \in {1,2,3}} \gamma^j \cdot L_j((r’<em>1, r’_2)) + \gamma^4 G’((r’_1, r’_2)) \cdot \widetilde{eq}((\beta’_1, \beta’_2), (r’_1, r’_2)) <br />
&amp;= \sum</em>{j \in {1,2,3}} \gamma^j \cdot \widetilde{eq}((r_1, r_2), (r’<em>1, r’_2)) \cdot H_j((r’_1, r’_2)) \ 
&amp;+ \gamma^4 \cdot (\sum</em>{y \in {0, 1 }^3} \widetilde{M_1}((r’<em>1, r’_2), y) \cdot \widetilde{z}’_2(y) \cdot \sum</em>{y \in {0, 1 }^{3}} \widetilde{M_2}((r’<em>1, r’_2), y) \cdot \widetilde{z}’_2(y)) \ 
&amp;- (\sum</em>{y \in {0, 1 }^{3}} \widetilde{M_3}((r’_1, r’_2), y) \cdot \widetilde{z}’_2(y)))) \cdot \widetilde{eq}((\beta’_1, \beta’_2), (r’_1, r’_2))) <br />
&amp;= (\gamma \cdot \sigma_1 + \gamma^2 \cdot  \sigma_2 + \gamma^3 \cdot \sigma_3) \cdot \widetilde{eq}((r_1, r_2), (r’_1, r’_2)) \ 
&amp;+ \gamma^4 \cdot (\theta_1 * \theta_2 - \theta_3) \cdot \widetilde{eq}((\beta’_1, \beta’_2), (r’_1, r’_2)))
\end{aligned}
$</p>

<p>To assist the verifier, the prover sends $\sigma_i$ and $\theta_i$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">v_generator</span><span class="p">(</span><span class="n">Mi</span><span class="p">,</span> <span class="n">zi</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span>
        <span class="nb">sum</span><span class="p">([</span>
            <span class="nb">sum</span><span class="p">([</span>
                <span class="n">Mi_linear</span><span class="p">(</span><span class="n">Mi</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zi</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y3</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">y2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">y1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

<span class="n">sigma1</span> <span class="o">=</span> <span class="n">v_generator</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">zz1</span><span class="p">)</span>
<span class="n">sigma2</span> <span class="o">=</span> <span class="n">v_generator</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="n">zz1</span><span class="p">)</span>
<span class="n">sigma3</span> <span class="o">=</span> <span class="n">v_generator</span><span class="p">(</span><span class="n">M3</span><span class="p">,</span> <span class="n">zz1</span><span class="p">)</span>

<span class="n">theta1</span> <span class="o">=</span> <span class="n">v_generator</span><span class="p">(</span><span class="n">M1</span><span class="p">,</span> <span class="n">zz2</span><span class="p">)</span>
<span class="n">theta2</span> <span class="o">=</span> <span class="n">v_generator</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="n">zz2</span><span class="p">)</span>
<span class="n">theta3</span> <span class="o">=</span> <span class="n">v_generator</span><span class="p">(</span><span class="n">M3</span><span class="p">,</span> <span class="n">zz2</span><span class="p">)</span>

<span class="p">(</span><span class="n">sigma1</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">sigma3</span><span class="p">),</span> <span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">,</span> <span class="n">theta3</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>((-9, -23, 49), (-18, 45, 3))
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">g</span><span class="p">(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span><span class="n">rr2</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">sigma1</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma2</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="n">sigma3</span><span class="p">)</span> <span class="o">*</span> <span class="n">eqx</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="n">r1</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">r2</span><span class="p">,</span> <span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span><span class="n">rr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">^</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta1</span> <span class="o">*</span> <span class="n">theta2</span> <span class="o">-</span> <span class="n">theta3</span><span class="p">)</span> <span class="o">*</span> <span class="n">eqx</span><span class="p">(</span><span class="n">x1</span><span class="o">=</span><span class="n">beta11</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">beta22</span><span class="p">,</span> <span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span><span class="n">rr2</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>To avoid doing many sum-checks, the verifier samples a random challenge $\rho$ and reduces the task to checking</p>

<p>$\sigma_i + \rho \cdot \theta_i = \sum_{y \in {0,1}^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y))$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rho</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">rho</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>45
</code></pre></div></div>

<h3 id="accumulating-sum-checks-into-r3-in-mathcalrlcccs">Accumulating sum-checks into $R’<em>3 \in \mathcal{R}</em>{LCCCS}$</h3>

<p>Instead of engaging in a sum-check now, we construct $R’<em>3 \in \mathcal{R}</em>{LCCCS}$, which serves as an accumulation of all the remaining inner sum-checks:</p>

<p>$R’_3 = (s, C’_3, (u’_3, \times’_3, (r’_1, r’_2), {v’_1,v’_2,v’_3}))$</p>

<p>where</p>
<ul>
  <li>$C’_3 = C’1 + \rho \cdot C_2$</li>
  <li>$u’_3 = 1 + \rho \cdot 1$</li>
  <li>$\times’_3 = \times’_1 + \rho \cdot \times’2$</li>
  <li>$v’_i = \sigma_i + \rho \cdot \theta_i$</li>
</ul>

<p>Checking the $R’_3$ relation is equivalent to checking</p>

<p>$v’<em>i = \sum</em>{y \in {0,1}^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y))$</p>

<p>for all $i \in {1,2,3}$.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">u3</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rho</span>
<span class="n">public_xx3</span> <span class="o">=</span> <span class="n">public_xx1</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">public_xx2</span>
<span class="n">vv1</span> <span class="o">=</span> <span class="n">sigma1</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">theta1</span>
<span class="n">vv2</span> <span class="o">=</span> <span class="n">sigma2</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">theta2</span>
<span class="n">vv3</span> <span class="o">=</span> <span class="n">sigma3</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">theta3</span>
</code></pre></div></div>

<h2 id="verifying-the-folded-instance">Verifying the folded instance</h2>

<div class="alert alert-block alert-info">
Note that until now, the prover and verifier have only been engaging in outer sum-checks, but haven't engaged in any inner sum-check yet; they have been delaying or accumulating them.
</div>

<p>We are left with a linearised CCCS relation $R’_3$. Since our goal was only to compute two iterations, we can finally compute the sum-check on this instance. Had we wanted to run more iterations, we would accumulate these sum-checks further.</p>

<p>$v’<em>i = \sum</em>{y \in {0,1}^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y))$</p>

<p>where $v’_i = \sigma_i + \rho \cdot \theta_i$</p>

<p>Note that checking $v’_i$ implies checking both $\sigma_i$ and $\theta_i$ with high probability.</p>

<p>By batching all $v’_i$ with a random linear combination, checking</p>

<p>$\begin{aligned}
v’<em>1 + \alpha v’_2 + \alpha^2 v’_3 &amp;= \sum</em>{y \in {0,1}^3} \widetilde{M_1}((r’<em>1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y)) <br />
&amp;+ \alpha \cdot \sum</em>{y \in {0,1}^3} \widetilde{M_2}((r’<em>1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y)) <br />
&amp;+ \alpha^2 \cdot \sum</em>{y \in {0,1}^3} \widetilde{M_3}((r’_1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y)) <br />
\end{aligned}$</p>

<p>implies with high probability that</p>

<p>$v’<em>i = \sum</em>{y \in {0,1}^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y))$</p>

<p>which in turn implies that $\sigma_i$ and $\theta_i$ for $i \in {1,2,3}$ are computed correctly as the prover previously claimed.</p>

<h3 id="batching-sum-checks-from-r3-in-mathcalrlcccs">Batching sum-checks from $R’<em>3 \in \mathcal{R}</em>{LCCCS}$</h3>

<p>The verifier samples $\alpha \in \mathbb{F}$ randomly to check</p>

<p>$\begin{aligned}
v’ &amp;= \sum_{y \in {0,1}^3} \widetilde{M_1}((r’<em>1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y)) <br />
&amp;+ \alpha \cdot \sum</em>{y \in {0,1}^3} \widetilde{M_2}((r’<em>1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y)) <br />
&amp;+ \alpha^2 \cdot \sum</em>{y \in {0,1}^3} \widetilde{M_3}((r’<em>1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y)) <br />
&amp;= \sum</em>{y \in {0,1}^3} (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y)) \cdot (\widetilde{M_1}((r’_1, r’_2), y) <br />
&amp; \quad \quad \quad \quad + \alpha \cdot \widetilde{M_2}((r’_1, r’_2), y) + \alpha^2 \cdot \widetilde{M_3}((r’_1, r’_2), y))
\end{aligned}$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">alpha</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">alpha</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>81
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
        <span class="nb">sum</span><span class="p">([</span>
            <span class="nb">sum</span><span class="p">([</span>
                <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M1</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">))</span> <span class="o">+</span>
                <span class="n">alpha</span> <span class="o">*</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M2</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">))</span> <span class="o">+</span>
                <span class="n">alpha</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M3</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">y1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">y3</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">y2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">y1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

<span class="n">vv</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>17
</code></pre></div></div>

<h4 id="round-1-2">Round 1</h4>

<p>$\begin{aligned}
v’<em>{11} &amp;= \sum</em>{y_2 \in {0,1}} \sum_{y_3 \in {0,1}} \widetilde{M_1}((r’<em>1, r’_2), (Y_1, y_2, y_3)) \cdot (\widetilde{z}’_1((Y_1, y_2, y_3)) + \rho \cdot \widetilde{z}’_2((Y_1, y_2, y_3))) <br />
&amp;+ \alpha \cdot \sum</em>{y_2 \in {0,1}} \sum_{y_3 \in {0,1}} \widetilde{M_2}((r’<em>1, r’_2), (Y_1, y_2, y_3)) \cdot (\widetilde{z}’_1((Y_1, y_2, y_3)) + \rho \cdot \widetilde{z}’_2((Y_1, y_2, y_3))) <br />
&amp;+ \alpha^2 \cdot \sum</em>{y_2 \in {0,1}} \sum_{y_3 \in {0,1}} \widetilde{M_3}((r’_1, r’_2), (Y_1, y_2, y_3)) \cdot (\widetilde{z}’_1((Y_1, y_2, y_3)) + \rho \cdot \widetilde{z}’_2((Y_1, y_2, y_3)))
\end{aligned}$</p>

<p>Prover sends $q_1$ claiming to be equal to $v’_{11}$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vv11</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
        <span class="nb">sum</span><span class="p">([</span>
            <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M1</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">))</span> <span class="o">+</span>
                <span class="n">alpha</span> <span class="o">*</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M2</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">))</span> <span class="o">+</span>
                <span class="n">alpha</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M3</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y22</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">y3</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">y2</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">q1</span> <span class="o">=</span> <span class="n">vv11</span>

<span class="n">q1</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>32*y11^2 - 28*y11 - 44
</code></pre></div></div>

<p>Verifier checks that $q_1(0) + q_1(1) = v’$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">q1</span><span class="p">(</span><span class="n">y11</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">q1</span><span class="p">(</span><span class="n">y11</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">vv</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>Verifier computes a random element $r’‘_1$ to check that $q_1$ is actually $v’$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rrr1</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">rrr1</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>77
</code></pre></div></div>

<h4 id="round-2">Round 2</h4>

<p>$\begin{aligned}
v’<em>{12} &amp;= \sum</em>{y_3 \in {0,1}} \widetilde{M_1}((r’<em>1, r’_2), (r’‘_1, Y_2, y_3)) \cdot (\widetilde{z}’_1((r’‘_1, Y_2, y_3)) + \rho \cdot \widetilde{z}’_2((r’‘_1, Y_2, y_3))) <br />
&amp;+ \alpha \cdot \sum</em>{y_3 \in {0,1}} \widetilde{M_2}((r’<em>1, r’_2), (r’‘_1, Y_2, y_3)) \cdot (\widetilde{z}’_1((r’‘_1, Y_2, y_3)) + \rho \cdot \widetilde{z}’_2((Y_1, Y_2, y_3))) <br />
&amp;+ \alpha^2 \cdot \sum</em>{y_3 \in {0,1}} \widetilde{M_3}((r’_1, r’_2), (r’‘_1, Y_2, y_3)) \cdot (\widetilde{z}’_1((r’‘_1, Y_2, y_3)) + \rho \cdot \widetilde{z}’_2((r’‘_1, Y_2, y_3)))
\end{aligned}$</p>

<p>Prover sends $q_2$ claiming to be equal to $v’_{12}$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vv12</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
        <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M1</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">))</span> <span class="o">+</span> 
        <span class="n">alpha</span> <span class="o">*</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M2</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">))</span> <span class="o">+</span>
        <span class="n">alpha</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M3</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y33</span><span class="o">=</span><span class="n">y3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">y3</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">q2</span> <span class="o">=</span> <span class="n">vv12</span>

<span class="n">q2</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-3*y22^2 + 36*y22 + 46
</code></pre></div></div>

<p>Verifier checks that $q_2(0) + q_2(1) = q_1(r’‘_1)$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Verifier checks 
</span><span class="n">q2</span><span class="p">(</span><span class="n">y22</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">q2</span><span class="p">(</span><span class="n">y22</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">q1</span><span class="p">(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>Verifier computes a random element $r’‘<em>2$ to check that $q_2$ is actually $v’</em>{12}$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rrr2</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">rrr2</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5
</code></pre></div></div>

<h4 id="round-3">Round 3</h4>
<p>\(v'_{13} = \widetilde{M_1}((r'_1, r'_2), (r''_1, r''_2, y_3)) \cdot (\widetilde{z}'_1((r''_1, r''_2, y_3)) + \rho \cdot \widetilde{z}'_2((r''_1, r''_2, y_3)))\)</p>

<p>Prover sends $q_3$ claiming to be equal to $v’_{13}$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vv13</span> <span class="o">=</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M1</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">))</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M2</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">))</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M3</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">))</span>
<span class="n">q3</span> <span class="o">=</span> <span class="n">vv13</span>

<span class="n">q3</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2*y33^2 + 29*y33 + 31
</code></pre></div></div>

<p>Verifier checks that $q_3(0) + q_3(1) = q_2(r’‘_2)$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">q3</span><span class="p">(</span><span class="n">y33</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">q3</span><span class="p">(</span><span class="n">y33</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">q2</span><span class="p">(</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>Verifier computes a random element $r’‘<em>3$ to check that $q_3$ is actually $v’</em>{13}$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rrr3</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">random_element</span><span class="p">()</span>
<span class="n">rrr3</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>30
</code></pre></div></div>

<p>The verifier can compute now on his own</p>

<p>$\begin{aligned}
&amp;\widetilde{M_1}((r’_1, r’_2), (r’‘_1, r’‘_2, r’‘_3)) \cdot (\widetilde{z}’_1((r’‘_1, r’‘_2, r’‘_3)) + \rho \cdot \widetilde{z}’_2((r’‘_1, r’‘_2, r’‘_3))) <br />
&amp;+ \alpha \cdot \widetilde{M_2}((r’_1, r’_2), (r’‘_1, r’‘_2, r’‘_3)) \cdot (\widetilde{z}’_1((r’‘_1, r’‘_2, r’‘_3)) + \rho \cdot \widetilde{z}’_2((r’‘_1, r’‘_2, r’‘_3))) <br />
&amp;+ \alpha^2 \cdot \widetilde{M_3}((r’_1, r’_2), (r’‘_1, r’‘_2, r’‘_3)) \cdot (\widetilde{z}’_1((r’‘_1, r’‘_2, r’‘_3)) + \rho \cdot \widetilde{z}’_2((r’‘_1, r’‘_2, r’‘_3))) <br />
&amp;= (\widetilde{M_1}((r’_1, r’_2), (r’‘_1, r’‘_2, r’‘_3)) + \alpha \cdot \widetilde{M_2}((r’_1, r’_2), (r’‘_1, r’‘_2, r’‘_3)) <br />
&amp;+ \alpha^2 \cdot \widetilde{M_3}((r’_1, r’_2), (r’‘_1, r’‘_2, r’‘_3))) \cdot (\widetilde{z}’_1((r’‘_1, r’‘_2, r’‘_3)) + \rho \cdot \widetilde{z}’_2((r’‘_1, r’‘_2, r’‘_3)))
\end{aligned}$</p>

<p>and check that $q(r’‘_3)$ is indeed that random linear combination.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">c1</span> <span class="o">=</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M1</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">rrr3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">rrr3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">rrr3</span><span class="p">))</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M2</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">rrr3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">rrr3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">rrr3</span><span class="p">))</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">^</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Mi_linear</span><span class="p">(</span><span class="n">M3</span><span class="p">)(</span><span class="n">x11</span><span class="o">=</span><span class="n">rr1</span><span class="p">,</span> <span class="n">x22</span><span class="o">=</span> <span class="n">rr2</span><span class="p">,</span> <span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">rrr3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z_linear</span><span class="p">(</span><span class="n">zz1</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">rrr3</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">z_linear</span><span class="p">(</span><span class="n">zz2</span><span class="p">)(</span><span class="n">y11</span><span class="o">=</span><span class="n">rrr1</span><span class="p">,</span><span class="n">y22</span><span class="o">=</span><span class="n">rrr2</span><span class="p">,</span> <span class="n">y33</span><span class="o">=</span><span class="n">rrr3</span><span class="p">))</span>

<span class="n">c1</span> <span class="o">==</span> <span class="n">q3</span><span class="p">(</span><span class="n">y33</span><span class="o">=</span><span class="n">rrr3</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<h3 id="the-domino-effect">The Domino Effect</h3>

<blockquote>
  <p>For reference:</p>
  <ul>
    <li>$\begin{aligned}
  G’((X_1, X_2)) := &amp; \sum_{y \in {0, 1 }^3} \widetilde{M_1}((X_1, X_2), y) \cdot \widetilde{z}’<em>2(y) \cdot \sum</em>{y \in {0, 1 }^{3}} \widetilde{M_2}((X_1, X_2), y) \cdot \widetilde{z}’<em>2(y) \  - &amp; (\sum</em>{y \in {0, 1 }^{3}} \widetilde{M_3}((X_1, X_2), y) \cdot \widetilde{z}’_2(y)) = 0
  \end{aligned}$</li>
    <li>$Q’(X_1, X_2) := G’((X_1, X_2)) \cdot \widetilde{eq}((\beta’_1, \beta’_2), (X_1, X_2))$</li>
    <li>$L_i((X_1, X_2)) = \widetilde{eq}((r_1, r_2), (X_1, X_2)) \cdot H_i((X_1, X_2))$</li>
    <li>$H_i((X_1, X_2)) := \sum_{y\in {0,1}^3} \widetilde{M}_i((X_1, X_2),y) \cdot \widetilde{z}’_1(y)$</li>
    <li>$\sigma_i = H_i((r’<em>1, r’_2)) = \sum</em>{y \in {0, 1 }^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot \widetilde{z}’_1(y)$</li>
    <li>$\theta_i = L_i((r’<em>1, r’_2)) = \sum</em>{y \in {0, 1 }^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot \widetilde{z}’_2(y)$</li>
    <li>$g_1((X_1, X_2)) = \sum_{j \in {1,2,3}} \gamma^j \cdot L_j((X_1, X_2))$</li>
    <li>$g((X_1, X_2)) = g_1((X_1, X_2)) + \gamma^4 Q’((X_1, X_2))$</li>
  </ul>
</blockquote>

<p>The verifier has now checked that $v’<em>1, v’_2, v’_3$ from $R’_3$ are the values that the prover claimed by checking their random linear combination. This in turn implies that $\sigma_1, \sigma_2, \sigma_3$ and $\theta_1, \theta_2, \theta_3$ are indeed the values that the prover’s claimed. Thus, the verifier is assured about the validity of the sum-checks from $R’_1 \in \mathcal{R}</em>{LCCCS}$ and $R’<em>2 \in \mathcal{R}</em>{CCCS}$</p>

<p>In other words, by checking that</p>

<p>$\sum_{j \in {1,2,3}} \gamma^j \cdot v_j + \gamma^4 \cdot 0 = \sum_{x_1 \in {0, 1 }} \sum_{x_2 \in {0, 1 }} g((x_1, x_2))$, for $g(x) = g_1(x) + \gamma^4 Q’(x)$,</p>

<p>the verifier is thus implicitely verifying all claims of $R’<em>1 \in \mathcal{R}</em>{LCCCS}$ and $R’<em>2 \in \mathcal{R}</em>{CCCS}$, which are encoded in $g_1$ and $Q’(x)$, respectively. We can apply recursively this logic, since $R_3 = R’<em>1$, which checks $R_2 \in \mathcal{R}</em>{CCCS}$ and $R_1 \in \mathcal{R}_{LCCCS}$.</p>

<p>More precisely, checking</p>

<p>$\begin{aligned}
v’ = v’<em>1 + \alpha v’_2 + \alpha^2 v’_3 &amp;= \sum</em>{y \in {0,1}^3} \widetilde{M_1}((r’<em>1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y)) <br />
&amp;+ \alpha \cdot \sum</em>{y \in {0,1}^3} \widetilde{M_2}((r’<em>1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y)) <br />
&amp;+ \alpha^2 \cdot \sum</em>{y \in {0,1}^3} \widetilde{M_3}((r’_1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y))
\end{aligned}$</p>

<p>implies with high probability that</p>

<p>$v’<em>i = \sum</em>{y \in {0,1}^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot (\widetilde{z}’_1(y) + \rho \cdot \widetilde{z}’_2(y))$</p>

<p>which implies with high probability that</p>

<ul>
  <li>$\sigma_i = \sum_{y \in {0, 1 }^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot \widetilde{z}’_1(y)$</li>
  <li>$\theta_i = \sum_{y \in {0, 1 }^3} \widetilde{M_i}((r’_1, r’_2), y) \cdot \widetilde{z}’_2(y)$</li>
</ul>

<p>which allows the verifier to verify that</p>

<p>$
\begin{aligned}
s’<em>2(r’_2) &amp;= g’_2(r’_2) \ 
&amp;= g((r’_1, r’_2)) <br />
&amp;= g_1((r’_1, r’_2)) + \gamma^4 Q’((r’_1, r’_2)) <br />
&amp;= \sum</em>{j \in {1,2,3}} \gamma^j \cdot L_j((r’<em>1, r’_2)) + \gamma^4 G’((r’_1, r’_2)) \cdot \widetilde{eq}((\beta’_1, \beta’_2), (r’_1, r’_2)) <br />
&amp;= \sum</em>{j \in {1,2,3}} \gamma^j \cdot \widetilde{eq}((r_1, r_2), (r’<em>1, r’_2)) \cdot H_j((r’_1, r’_2)) \ 
&amp;+ \gamma^4 \cdot (\sum</em>{y \in {0, 1 }^3} \widetilde{M_1}((r’<em>1, r’_2), y) \cdot \widetilde{z}’_2(y) \cdot \sum</em>{y \in {0, 1 }^{3}} \widetilde{M_2}((r’<em>1, r’_2), y) \cdot \widetilde{z}’_2(y)) \ 
&amp; \quad \quad \quad \quad - (\sum</em>{y \in {0, 1 }^{3}} \widetilde{M_3}((r’_1, r’_2), y) \cdot \widetilde{z}’_2(y)))) \cdot \widetilde{eq}((\beta’_1, \beta’_2), (r’_1, r’_2))) <br />
&amp;= (\gamma \cdot \sigma_1 + \gamma^2 \cdot  \sigma_2 + \gamma^3 \cdot \sigma_3) \cdot \widetilde{eq}((r_1, r_2), (r’_1, r’_2)) \ 
&amp; \quad \quad + \gamma^4 \cdot (\theta_1 * \theta_2 - \theta_3) \cdot \widetilde{eq}((\beta’_1, \beta’_2), (r’_1, r’_2)))
\end{aligned}
$</p>

<p>which he previously assumed to be true, from the values $\sigma_i$ and $\theta_i$ given by the prover.</p>

<p>This implies that</p>

<p>$\sum_{j \in {1,2,3}} \gamma^j \cdot v_j + \gamma^4 \cdot 0 = \sum_{x_1 \in {0, 1 }} \sum_{x_2 \in {0, 1 }}  g((x_1, x_2)) = g_1(x) + \gamma^4 Q’(x)$</p>

<p>which implies with high probability that</p>

<p>$\begin{aligned}
\sum_{j \in {1,2,3}} \gamma^j \cdot v_j = \sum_{x_1 \in {0, 1 }} \sum_{x_2 \in {0, 1 }}  g_1((x_1, x_2)) &amp;\overset{w.h.p}{\Longrightarrow} v_i = \sum_{x_1 \in {0, 1 }} \sum_{x_2 \in {0, 1 }}  L_i((x_1, x_2)) \text{ for } i \in {1,2,3} <br />
&amp;\Longrightarrow v_i = H_i((r_1, r_2)) \text{ for } i \in {1,2,3} <br />
&amp;\Longrightarrow R’<em>1 \in \mathcal{R}</em>{LCCCS} \text{ is a valid instance.} <br />
&amp;\Longrightarrow R_1 \in \mathcal{R}<em>{LCCCS}, R_2 \in \mathcal{R}</em>{CCCS} \text{ are valid instances. }
\end{aligned}$</p>

<p>and
$\begin{aligned}
\sum_{x_1 \in {0,1}}\sum_{x_2 \in {0,1}} Q’(x_1, x_2) &amp;\Longrightarrow \forall x_1, x_2 \in {0,1}. G’((x_1, x_2)) = 0 <br />
&amp;\Longrightarrow R’<em>2 \in \mathcal{R}</em>{CCCS} \text{ is a valid instance.}
\end{aligned}$</p>

<h2 id="summary">Summary</h2>

<p>We made it, again! We have managed to fold two iterations of our Fibonacci example and then verify the folding protocol by sum-checking the final linearised CCCS relation $R’_3$.</p>

<p>At each iteration, the incoming relation $R^{(k)}<em>2 \in \mathcal{R}</em>{CCCS}$ generates random values $r^{(k)} \in \mathbb{F}$ that are propagated to the next accumulated relation $R^{(k+1)}<em>1 \in \mathcal{R}</em>{LCCCS}$. This serves as the glue that makes the domino effect possible.</p>

<p>We batched many of the sum-checks into a single sum-check using a random linear combination of the sums, thus avoiding unnecessary computation when needed.</p>

<p>There was a lot of work and wit put into SuperSpartan and HyperNova. I hope this post contributes to spread the understanding of such inspiring work.</p>

<p>Thanks for reading!</p>

  </div><a class="u-url" href="/cryptography/2024/08/05/hypernova-by-hand.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Alberto Centelles</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Alberto Centelles</li><li><a class="u-email" href="mailto:centelles.alberto@gmail.com">centelles.alberto@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
